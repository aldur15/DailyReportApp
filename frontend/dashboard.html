<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <style>
    .report, .history-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Welcome</h2>
  <button id="logout">Logout</button>

  <h3>Create Daily Report</h3>
  <form id="report-form">
    <input type="text" id="title" placeholder="Report title" required />
    <br />
    <textarea id="summary" placeholder="What happened today?" required></textarea>
    <br />
    <input type="date" id="date" />
    <br />
    <button type="submit">Submit Report</button>
  </form>

  <div id="admin-section" style="display: none; margin-top: 40px;">
    <h3>Promote User to Admin</h3>
    <form id="make-admin-form">
      <input type="text" id="promote-username" placeholder="Username to promote" required />
      <button type="submit">Make Admin</button>
    </form>

    <h3>Search Daily Reports</h3>
    <form id="search-form">
      <input type="text" id="search-username" placeholder="Search by username" />
      <input type="text" id="search-title" placeholder="Search by title" />
      <input type="date" id="search-date" />
      <input type="month" id="search-month" />
      <button type="button" id="clear-filters">Clear Filters</button>
      <button type="button" id="show-all">Show All</button>
      <button type="button" id="hide-all">Hide All</button>
    </form>

    <div id="report-container" style="margin-top: 20px;"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "index.html";

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    });

    function renderReports(data) {
      const container = document.getElementById("report-container");
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = "<p>No reports found.</p>";
        return;
      }
      data.forEach(report => {
        const div = document.createElement("div");
        div.className = "report";
        const username = report.username || (report.user && report.user.name) || "Unknown";
        div.innerHTML = `
          <strong>${report.title}</strong> - <em>${new Date(report.date).toLocaleString()}</em><br />
          <small>By: ${username}</small>${report.edited ? " <span style='color:orange'>(edited)</span>" : ""}
          <p>${report.summary}</p>
          <button onclick="openEditForm(${report.id}, '${report.title}', \`${report.summary}\`, '${report.date}')">Edit</button>
          <button onclick="showHistory(${report.id})">History</button>
          <button onclick="hideHistory(${report.id})">Hide History</button>
          <button onclick="deleteReport(${report.id})">Delete</button>
          <div id="history-${report.id}"></div>
        `;
        container.appendChild(div);
      });
    }

    function openEditForm(id, title, summary, date) {
      const newTitle = prompt("New title:", title);
      if (newTitle === null) return;
      const newSummary = prompt("New summary:", summary);
      if (newSummary === null) return;
      const newDate = prompt("New date:", date);
      if (newDate === null) return;

      fetch(`http://localhost:8000/reports/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({ title: newTitle, summary: newSummary, date: newDate }),
      }).then(res => res.json()).then(data => {
        if (data.detail) alert("Error updating report: " + JSON.stringify(data));
        else {
          alert("Report updated");
          fetchReports();
        }
      });
    }

    function showHistory(id) {
      fetch(`http://localhost:8000/reports/${id}/history`, {
        headers: { Authorization: "Bearer " + token },
      })
        .then(res => res.json())
        .then(history => {
          const container = document.getElementById(`history-${id}`);
          container.innerHTML = history.length === 0 ? "<p>No history available.</p>" : history.map(v => `
            <div class="history-card">
              <strong>${v.title}</strong> - <em>${new Date(v.date).toLocaleString()}</em><br />
              <small>Saved: ${new Date(v.saved_at).toLocaleString()}</small>
              <p>${v.summary}</p>
            </div>
          `).join("");
        });
    }

    function hideHistory(id) {
      document.getElementById(`history-${id}`).innerHTML = "";
    }

    async function fetchReports() {
      const res = await fetch("http://localhost:8000/reports", {
        headers: { Authorization: "Bearer " + token },
      });
      res.ok ? renderReports(await res.json()) : document.getElementById("report-container").innerText = "Failed to load reports.";
    }

    async function fetchFilteredReports(username, title, date, month) {
      const params = new URLSearchParams();
      if (username) params.append("username", username);
      if (title) params.append("title", title);
      if (date) params.append("date", date);
      if (month) {
        const [year, monthNum] = month.split("-");
        params.append("month", monthNum);
        params.append("year", year);
      }
      const res = await fetch("http://localhost:8000/reports/search?" + params.toString(), {
        headers: { Authorization: "Bearer " + token },
      });
      res.ok ? renderReports(await res.json()) : alert("Error fetching filtered reports");
    }

    async function checkIfAdmin() {
      const res = await fetch("http://localhost:8000/users/me", {
        headers: { Authorization: "Bearer " + token },
      });
      if (res.ok) {
        const user = await res.json();
        if (user.is_admin) {
          document.getElementById("admin-section").style.display = "block";
          fetchReports();
        }
      } else {
        alert("Session expired");
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    }

    checkIfAdmin();

    let debounceTimer;
    const debounce = (func, delay) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(func, delay);
    };

    const triggerFilter = () => {
      const username = document.getElementById("search-username").value;
      const title = document.getElementById("search-title").value;
      const date = document.getElementById("search-date").value;
      const month = document.getElementById("search-month").value;
      fetchFilteredReports(username, title, date, month);
    };

    ["search-username", "search-title", "search-date", "search-month"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => debounce(triggerFilter, 300));
    });

    document.getElementById("clear-filters").addEventListener("click", () => {
      ["search-username", "search-title", "search-date", "search-month"].forEach(id => document.getElementById(id).value = "");
      fetchReports();
    });

    document.getElementById("show-all").addEventListener("click", fetchReports);
    document.getElementById("hide-all").addEventListener("click", () => {
      document.getElementById("report-container").innerHTML = "";
    });

    document.getElementById("report-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const summary = document.getElementById("summary").value;
      const date = document.getElementById("date").value || null;
      const res = await fetch("http://localhost:8000/reports", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({ title, summary, date }),
      });
      if (res.ok) {
        alert("Report submitted!");
        document.getElementById("report-form").reset();
        checkIfAdmin();
      } else {
        alert("Error submitting report: " + JSON.stringify(await res.json()));
      }
    });

    document.getElementById("make-admin-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("promote-username").value;
      const res = await fetch("http://localhost:8000/make-admin", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({ username }),
      });
      if (res.ok) {
        alert((await res.json()).message);
        document.getElementById("make-admin-form").reset();
      } else {
        alert("Error: " + JSON.stringify(await res.json()));
      }
    });

    document.getElementById("date").valueAsDate = new Date();

     function deleteReport(id) {
    if (!confirm("Are you sure you want to delete this report?")) return;

    fetch(`http://localhost:8000/reports/${id}`, {
      method: "DELETE",
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then(res => {
        if (res.ok) {
          alert("Report deleted.");
          fetchReports();
        } else {
          return res.json().then(data => {
            alert("Error deleting report: " + (data.detail || JSON.stringify(data)));
          });
        }
      })
      .catch(err => alert("Request failed: " + err));
  }
  </script>
</body>
</html>
